<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Chat AI</title>
  <style>
    :root{
      --bg: #0f1222; --panel:#151836; --panel-2:#1b1f45; --accent:#7c5cff; --text:#e8e9f1; --muted:#a9acc7; --danger:#ff5c7a;
      --radius: 16px; --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% -10%, #20245a 0%, transparent 60%),
                  radial-gradient(1000px 500px at 110% 0%, #2a215a 0%, transparent 70%),
                  var(--bg);
      color:var(--text);
      display:grid; place-items:center; padding:20px;
    }
    .app{width:min(1000px,100%); display:grid; gap:14px}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between}
    .title{display:flex; align-items:center; gap:12px}
    .logo{width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg, var(--accent), #5c9bff); box-shadow: var(--shadow); display:grid; place-items:center; font-weight:900}
    .logo span{filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .meta{font-size:12px; color:var(--muted)}

    .card{background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow:var(--shadow)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}

    /* Chat area */
    .chat{min-height:360px; max-height:60vh; overflow:auto; padding:16px; scroll-behavior:smooth}
    .msg{display:flex; gap:10px; margin:10px 0; align-items:flex-start}
    .msg .avatar{width:36px; height:36px; border-radius:50%; flex:0 0 auto; display:grid; place-items:center; font-weight:700}
    .msg.user .avatar{background:#2a2f6b}
    .msg.bot  .avatar{background:#2b1c69}
    .bubble{padding:12px 14px; border-radius:14px; line-height:1.4; max-width:75%}
    .msg.user .bubble{background:#1f244d}
    .msg.bot  .bubble{background:#211c5e}
    .time{display:block; margin-top:6px; color:var(--muted); font-size:11px}

    /* Composer */
    .composer{display:grid; grid-template-columns: auto 1fr auto; gap:10px; padding:12px; align-items:center}
    .txt{width:100%; resize:none; background:#161a3a; color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px 12px; height:48px}
    .btn{border:0; border-radius:12px; padding:12px 14px; color:white; font-weight:600; cursor:pointer; transition:.2s transform ease, .2s opacity ease}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn.primary{background:linear-gradient(135deg, var(--accent), #5c9bff)}
    .btn.mic{background:linear-gradient(135deg, #24b47e, #2bd8a7)}
    .btn.stop{background:linear-gradient(135deg, var(--danger), #ff8aa1)}

    /* Controls */
    .controls{padding:12px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px}
    .control{display:flex; gap:8px; align-items:center; font-size:14px; color:var(--muted)}
    select, input[type="range"]{width:100%; background:#161a3a; color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:8px}
    label{font-size:12px; color:var(--muted)}

    .note{padding:10px 12px; font-size:13px; color:var(--muted)}
    .kbd{display:inline-block; padding:2px 6px; border-radius:6px; background:#1c2047; border:1px solid rgba(255,255,255,.08); color:#cfd1ee; font-size:12px}
    footer{color:var(--muted); font-size:12px; text-align:center; margin-top:6px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true"><span>üîä</span></div>
        <div>
          <h1 style="margin:0; font-size:22px">Voice Chat AI (no server needed)</h1>
          <div class="meta">Speak to it; it speaks back. Also supports typing.</div>
        </div>
      </div>
      <div class="row">
        <button id="testVoice" class="btn primary" title="Test the current TTS voice">üîà Test voice</button>
      </div>
    </header>

    <!-- Chat -->
    <section id="chat" class="card chat" aria-live="polite" aria-label="Chat transcript"></section>

    <!-- Composer -->
    <section class="card composer">
      <button id="micBtn" class="btn mic" title="Start voice input (Speech‚Äëto‚ÄëText)">üéôÔ∏è Start</button>
      <textarea id="input" class="txt" placeholder="Type or use the mic (Press Enter to send)‚Ä¶"></textarea>
      <button id="sendBtn" class="btn primary" title="Send message">‚û°Ô∏è Send</button>
      <div class="note" style="grid-column: 1 / -1;">
        Tip: Press <span class="kbd">Enter</span> to send, <span class="kbd">Shift+Enter</span> for a new line.
      </div>
    </section>

    <!-- Voice & language controls -->
    <section class="card controls">
      <div>
        <label for="lang">Recognition language</label>
        <select id="lang">
          <option value="auto">Auto-detect (beta)</option>
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="ar-SA">Arabic (Saudi)</option>
          <option value="ar-EG">Arabic (Egypt)</option>
          <option value="ar-AE">Arabic (UAE)</option>
          <option value="fr-FR">French</option>
          <option value="es-ES">Spanish</option>
        </select>
      </div>
      <div>
        <label for="voice">TTS voice</label>
        <select id="voice"></select>
      </div>
      <div>
        <label for="rate">Rate <span id="rateVal">1.0</span></label>
        <input id="rate" type="range" min="0.6" max="1.6" value="1" step="0.05" />
      </div>
      <div>
        <label for="pitch">Pitch <span id="pitchVal">1.0</span></label>
        <input id="pitch" type="range" min="0.6" max="1.6" value="1" step="0.05" />
      </div>
    </section>

    <footer>
      Built with the Web Speech API (SpeechRecognition + SpeechSynthesis). Works best in Chromium-based browsers. No server required.
    </footer>
  </div>

<script>
(function(){
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const micBtn = document.getElementById('micBtn');
  const langEl = document.getElementById('lang');
  const voiceEl = document.getElementById('voice');
  const rateEl = document.getElementById('rate');
  const pitchEl = document.getElementById('pitch');
  const rateVal = document.getElementById('rateVal');
  const pitchVal = document.getElementById('pitchVal');
  const testVoiceBtn = document.getElementById('testVoice');

  let voices = [];
  let currentVoice = null;
  let recognition = null;
  let listening = false;

  // Util: append message to chat
  function addMessage(role, text){
    const msg = document.createElement('div');
    msg.className = `msg ${role}`;
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'user' ? 'üßë' : 'ü§ñ';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    const time = document.createElement('span');
    time.className = 'time';
    time.textContent = new Date().toLocaleTimeString();
    bubble.appendChild(time);
    msg.append(avatar, bubble);
    chatEl.appendChild(msg);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // Simple offline brain (fallback)
  function localBrain(prompt){
    const p = prompt.trim().toLowerCase();
    if(!p) return "I'm listening!";
    if(/[\u0600-\u06FF]/.test(prompt)){
      // Arabic quick replies
      if(p.includes('ŸÖÿ±ÿ≠ÿ®ÿß')||p.includes('ÿßŸÑÿ≥ŸÑÿßŸÖ')) return 'ÿ£ŸáŸÑŸãÿß! ŸÉŸäŸÅ ÿ£ŸÇÿØÿ± ÿ£ÿ≥ÿßÿπÿØŸÉÿü';
      if(p.includes('ÿßÿ≥ŸÖŸÉ')) return 'ÿ£ŸÜÿß ŸÖÿ≥ÿßÿπÿØ ÿµŸàÿ™Ÿä ÿπŸÑŸâ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠. ÿ™ŸÇÿØÿ± ÿ™ŸÉŸÑŸÖŸÜŸä Ÿàÿ™ÿ≥ŸÖÿπ ÿ±ÿØŸä.';
      if(p.includes('ÿßŸÑŸàŸÇÿ™')||p.includes('ÿßŸÑÿ≥ÿßÿπŸá')) return 'ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ¢ŸÜ: ' + new Date().toLocaleTimeString();
      return 'ÿ™ŸÖÿßŸÖ! ŸÇŸÑÿ™: ' + prompt;
    }
    // English quick replies
    if(p.includes('hello')||p.includes('hi')) return 'Hey! How can I help today?';
    if(p.includes('time')) return 'The time is ' + new Date().toLocaleTimeString();
    if(p.includes('name')) return "I'm a browser-based voice assistant.";
    return "You said: " + prompt;
  }

  // Text-to-Speech
  function speak(text){
    if(!('speechSynthesis' in window)){
      console.warn('Speech Synthesis unsupported');
      return;
    }
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = parseFloat(rateEl.value || '1');
    utter.pitch = parseFloat(pitchEl.value || '1');
    if(currentVoice) utter.voice = currentVoice;
    speechSynthesis.cancel(); // stop any ongoing speech
    speechSynthesis.speak(utter);
  }

  // Load available voices
  function populateVoices(){
    voices = window.speechSynthesis.getVoices();
    voiceEl.innerHTML = '';
    voices.forEach((v,i)=>{
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceEl.appendChild(opt);
    });
    // Choose a sensible default (Arabic if page lang likely Arabic; else English)
    const prefer = navigator.language && navigator.language.startsWith('ar')
      ? voices.findIndex(v=>v.lang.startsWith('ar'))
      : voices.findIndex(v=>v.lang.startsWith('en'));
    voiceEl.value = prefer >= 0 ? prefer : 0;
    currentVoice = voices[voiceEl.value] || null;
  }
  window.speechSynthesis.onvoiceschanged = populateVoices;
  if (window.speechSynthesis.getVoices().length) populateVoices();

  voiceEl.addEventListener('change', ()=>{
    currentVoice = voices[voiceEl.value];
  });
  rateEl.addEventListener('input', ()=> rateVal.textContent = rateEl.value);
  pitchEl.addEventListener('input', ()=> pitchVal.textContent = pitchEl.value);
  testVoiceBtn.addEventListener('click', ()=> speak('This is a test of your selected voice. ŸÖÿ±ÿ≠ÿ®ÿßŸã!'));

  // Speech-to-Text
  function hasRecognition(){
    return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
  }

  function startListening(){
    if(!hasRecognition()){
      alert('Speech Recognition not supported in this browser. Try Chrome/Edge on desktop or Android.');
      return;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;
    const lang = langEl.value;
    if(lang && lang !== 'auto') recognition.lang = lang;

    let interim = '';
    listening = true;
    micBtn.textContent = 'üõë Stop';
    micBtn.classList.remove('mic'); micBtn.classList.add('stop');

    recognition.onresult = (e)=>{
      let finalText = '';
      for(let i=0;i<e.results.length;i++){
        const res = e.results[i];
        if(res.isFinal){ finalText += res[0].transcript; }
        else { interim = res[0].transcript; }
      }
      inputEl.value = finalText || interim;
    };
    recognition.onerror = (e)=>{
      console.error('STT error', e.error);
      stopListening();
    };
    recognition.onend = ()=>{
      // Auto-submit if we have text
      if(inputEl.value.trim()){
        sendFromInput();
      }
      stopListening();
    };
    recognition.start();
  }

  function stopListening(){
    if(recognition){ try{ recognition.stop(); }catch{} }
    listening = false;
    micBtn.textContent = 'üéôÔ∏è Start';
    micBtn.classList.remove('stop'); micBtn.classList.add('mic');
  }

  micBtn.addEventListener('click', ()=> listening ? stopListening() : startListening());

  // Send message
  async function sendFromInput(){
    const text = inputEl.value.trim();
    if(!text) return;
    inputEl.value = '';
    addMessage('user', text);

    // === Option A: Offline local brain ===
    let reply = localBrain(text);

    // === Option B (optional): Call your AI API ===
    // Replace the next block with a call to your backend. Example (requires your own proxy/server):
    // try {
    //   const r = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({messages:[{role:'user', content: text}]})});
    //   const data = await r.json();
    //   reply = data.reply || reply;
    // } catch(err) { console.warn('API error, using local brain:', err); }

    addMessage('bot', reply);
    speak(reply);
  }

  // UI events
  sendBtn.addEventListener('click', sendFromInput);
  inputEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendFromInput(); }
  });

  // Greeter
  addMessage('bot', 'Hi! I can hear you and talk back. Click \u201cStart\u201d and speak, or type below. ŸÖÿ±ÿ≠ÿ®ÿßŸã! ÿßÿ∂ÿ∫ÿ∑ ÿ®ÿØÿ° Ÿàÿ™ÿ≠ÿØÿ´.');
})();
</script>
</body>
</html>
